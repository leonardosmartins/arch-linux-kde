- name: Install pacman tools
  become: yes
  pacman:
    name:
      - reflector
      - pacman-contrib

- name: Optimize pacman mirrors
  become: yes
  block:
    - name: get current mirrors
      shell: cat /etc/pacman.d/mirrorlist
      register: mirrors
      changed_when: False
    - name: get mirrors stats
      stat:
        path: /etc/pacman.d/mirrorlist
      register: stats
      changed_when: False
    - name: update mirrors
      shell: reflector --protocol https --sort rate --save /etc/pacman.d/mirrorlist
      when: |
        mirrors.stdout.find('Arch Linux mirrorlist generated by Reflector') == -1
        or
        (ansible_date_time.epoch|int - stats.stat.mtime) > (7 * 60 * 60 * 24)
